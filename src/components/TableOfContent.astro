---
// 目录组件 - 客户端渲染
---

<div class="toc-wrapper" id="toc-wrapper">
  <div class="toc-indicator">
    <div class="toc-indicator-ball" id="toc-ball"></div>
  </div>
  <ul class="toc-list" id="toc-list"></ul>
</div>

<script>
  function initTableOfContent() {
    const content = document.getElementById('post-content');
    const tocList = document.getElementById('toc-list');
    const tocBall = document.getElementById('toc-ball');

    if (!content || !tocList) return;

    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    if (headings.length === 0) return;

    // 为每个标题添加 id
    const tocItems: { id: string; title: string; level: number; element: Element }[] = [];

    headings.forEach((heading, index) => {
      const id = `heading-${index}`;
      heading.id = id;

      const level = parseInt(heading.tagName.charAt(1));
      tocItems.push({
        id,
        title: heading.textContent || '',
        level,
        element: heading
      });
    });

    // 渲染目录
    const minLevel = Math.min(...tocItems.map(item => item.level));

    tocItems.forEach(item => {
      const li = document.createElement('li');
      li.className = 'toc-item';

      const a = document.createElement('a');
      a.href = `#${item.id}`;
      a.className = 'toc-link';
      a.textContent = item.title;
      a.style.paddingLeft = `${(item.level - minLevel) * 12}px`;
      a.dataset.id = item.id;

      a.addEventListener('click', (e) => {
        e.preventDefault();
        const target = document.getElementById(item.id);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth' });
        }
      });

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // 滚动监听
    let activeId = '';
    let ticking = false;

    const updateBallPosition = (activeLink: Element) => {
      if (tocBall && activeLink) {
        const linkHeight = (activeLink as HTMLElement).offsetHeight;
        const ballHeight = 12;
        const newTop = (activeLink as HTMLElement).offsetTop + (linkHeight - ballHeight) / 2;
        tocBall.style.transform = `translateY(${newTop}px)`;
      }
    };

    const handleScroll = () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          const scrollPosition = window.scrollY;

          for (let i = tocItems.length - 1; i >= 0; i--) {
            const heading = document.getElementById(tocItems[i].id);
            if (heading && heading.offsetTop <= scrollPosition + 100) {
              if (activeId !== tocItems[i].id) {
                // 移除旧的 active
                document.querySelectorAll('.toc-link.active').forEach(el => el.classList.remove('active'));
                // 添加新的 active
                const activeLink = document.querySelector(`.toc-link[data-id="${tocItems[i].id}"]`);
                if (activeLink) {
                  activeLink.classList.add('active');
                  updateBallPosition(activeLink);
                }
                activeId = tocItems[i].id;
              }
              break;
            }
          }
          ticking = false;
        });
        ticking = true;
      }
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    // 初始化时也执行一次
    handleScroll();
  }

  // 页面加载完成后初始化
  document.addEventListener('DOMContentLoaded', initTableOfContent);
  // 支持 Astro 的 View Transitions
  document.addEventListener('astro:page-load', initTableOfContent);
</script>

<style is:global>
  .toc-wrapper {
    position: relative;
    padding-left: 12px;
    margin-left: 12px;
  }

  .toc-indicator {
    position: absolute;
    left: 0;
    width: 2px;
    background-color: #eaecef;
    top: 0;
    bottom: 0;
  }

  html.dark .toc-indicator {
    background-color: #4a4a4a;
  }

  .toc-indicator-ball {
    position: absolute;
    left: -5px;
    top: 0;
    width: 12px;
    height: 12px;
    background-color: var(--primary-color);
    border: 2px solid #fff;
    border-radius: 50%;
    transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
  }

  html.dark .toc-indicator-ball {
    border-color: #141414;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    padding: 0;
    margin: 5px 0;
  }

  .toc-item:first-child {
    padding-top: 0;
  }

  .toc-link {
    color: rgba(0, 0, 0, 0.7);
    text-decoration: none;
    font-size: 12px;
    transition: color 0.3s;
    display: block;
    line-height: 1.4;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 160px;
  }

  html.dark .toc-link {
    color: rgba(255, 255, 255, 0.7);
  }

  .toc-link:hover,
  .toc-link.active {
    color: var(--primary-color);
  }
</style>
