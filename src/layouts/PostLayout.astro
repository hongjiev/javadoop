---
import '../styles/global.css';
import TableOfContent from '../components/TableOfContent.astro';
import { siteConfig } from '../config';
import type { CollectionEntry } from 'astro:content';

interface Props {
  post: CollectionEntry<'posts'>;
}

const { post } = Astro.props;
const { title, date } = post.data;
const description = post.data.description as string | undefined;

const copyrightText = siteConfig.copyright
  .replace('{siteName}', siteConfig.siteName)
  .replace('{year}', new Date().getFullYear().toString())
  .replace('{author}', siteConfig.author);
---

<!doctype html>
<html lang={siteConfig.lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description || siteConfig.description} />
    <title>{title} | {siteConfig.siteName}</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <!-- 防止主题闪烁 -->
    <script is:inline>
      (function() {
        const theme = document.cookie.match(/theme=(\w+)/)?.[1] || 'light';
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }
        const fontSize = document.cookie.match(/fontSize=(\d+)/)?.[1] || '16';
        document.documentElement.style.setProperty('--base-font-size', fontSize + 'px');
      })();
    </script>
  </head>
  <body>
    <div class="page-wrapper">
      <!-- 侧边栏切换按钮 -->
      <button class="sidebar-toggle" id="sidebar-toggle" aria-label="打开目录">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
      </button>

      <!-- 侧边栏 -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <button class="sidebar-close" id="sidebar-close" aria-label="关闭目录">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
        <div class="sidebar-content">
          <!-- 设置面板 -->
          <div class="settings">
            <ul class="settings-list">
              <li class="settings-item" id="font-decrease" title="减小字体">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9 4v3h5v12h3V7h5V4H9zm-6 8h6v3H3v-3z"/>
                </svg>
                <span>A-</span>
              </li>
              <li class="settings-item" id="font-increase" title="增大字体">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9 4v3h5v12h3V7h5V4H9zm-6 8h6v3H3v-3z"/>
                </svg>
                <span>A+</span>
              </li>
              <li class="settings-item" id="theme-dark" title="深色模式">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
                </svg>
              </li>
              <li class="settings-item" id="theme-light" title="浅色模式">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                </svg>
              </li>
            </ul>
          </div>
          <h3 class="sidebar-title">文章导航</h3>
          <TableOfContent />
        </div>
      </aside>

      <!-- 蒙层 -->
      <div class="sidebar-overlay" id="sidebar-overlay"></div>

      <!-- 主内容区 -->
      <main class="post-main" id="post-main">
        <div class="home-link-wrapper">
          <a href="/" class="home-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/>
            </svg>
            <span>回首页</span>
          </a>
        </div>

        <header class="post-header">
          <div class="title-row">
            <h1 class="post-title">{title}</h1>
            <a href={`/downloads/${post.id}`} download class="download-link" data-tooltip="下载原始 Markdown 文件">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/>
              </svg>
            </a>
          </div>
          <p class="post-date">发布时间: {date}</p>
        </header>

        <article class="post-content" id="post-content">
          <slot />
        </article>
      </main>

      <footer class="footer">
        <p>{copyrightText}</p>
      </footer>
    </div>
  </body>
</html>

<script>
  function initSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarClose = document.getElementById('sidebar-close');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const postMain = document.getElementById('post-main');

    if (!sidebar || !sidebarToggle || !sidebarClose || !postMain || !sidebarOverlay) return;

    const openSidebar = () => {
      sidebar.classList.add('visible');
      postMain.classList.add('shifted');
      sidebarToggle.classList.add('hidden');
      sidebarOverlay.classList.add('visible');
    };

    const closeSidebar = () => {
      sidebar.classList.remove('visible');
      postMain.classList.remove('shifted');
      sidebarToggle.classList.remove('hidden');
      sidebarOverlay.classList.remove('visible');
    };

    sidebarToggle.addEventListener('click', openSidebar);
    sidebarClose.addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);

    // 滚动时显示/隐藏切换按钮
    const handleScroll = () => {
      if (window.innerWidth <= 768) {
        if (window.scrollY > 200) {
          sidebarToggle.classList.add('show-mobile');
        } else {
          sidebarToggle.classList.remove('show-mobile');
        }
      } else {
        sidebarToggle.classList.add('show-mobile');
      }
    };

    window.addEventListener('scroll', handleScroll);
    window.addEventListener('resize', handleScroll);
    handleScroll();
  }

  function initSettings() {
    const fontDecrease = document.getElementById('font-decrease');
    const fontIncrease = document.getElementById('font-increase');
    const themeDark = document.getElementById('theme-dark');
    const themeLight = document.getElementById('theme-light');
    const postMain = document.getElementById('post-main');

    // Cookie 工具函数
    const setCookie = (name: string, value: string, days: number = 30) => {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${value}; expires=${expires}; path=/`;
    };

    const getCookie = (name: string): string | null => {
      const match = document.cookie.match(new RegExp(`${name}=([^;]+)`));
      return match ? match[1] : null;
    };

    // 字体大小
    let fontSize = parseInt(getCookie('fontSize') || '16', 10);

    const updateFontSize = () => {
      if (postMain) {
        postMain.style.fontSize = `${fontSize}px`;
      }
      document.documentElement.style.setProperty('--base-font-size', fontSize + 'px');
      setCookie('fontSize', fontSize.toString());
    };

    // 初始化字体大小
    updateFontSize();

    fontDecrease?.addEventListener('click', () => {
      fontSize = Math.max(fontSize - 1, 12);
      updateFontSize();
    });

    fontIncrease?.addEventListener('click', () => {
      fontSize = Math.min(fontSize + 1, 24);
      updateFontSize();
    });

    // 主题切换
    const setTheme = (theme: 'light' | 'dark') => {
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      setCookie('theme', theme);
    };

    themeDark?.addEventListener('click', () => setTheme('dark'));
    themeLight?.addEventListener('click', () => setTheme('light'));
  }

  document.addEventListener('DOMContentLoaded', () => {
    initSidebar();
    initSettings();
  });
  document.addEventListener('astro:page-load', () => {
    initSidebar();
    initSettings();
  });
</script>

<style>
  .page-wrapper {
    position: relative;
    overflow-x: hidden;
    min-height: 100vh;
  }

  /* 侧边栏切换按钮 */
  .sidebar-toggle {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1001;
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    padding: 0;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .sidebar-toggle.show-mobile {
    opacity: 1;
    visibility: visible;
  }

  .sidebar-toggle.hidden {
    opacity: 0 !important;
    visibility: hidden !important;
  }

  /* 侧边栏 */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 200px;
    height: 100%;
    background-color: #f0f2f5;
    transform: translateX(-200px);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: none;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
  }

  :global(html.dark) .sidebar {
    background-color: #2d333b;
  }

  .sidebar.visible {
    transform: translateX(0);
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
  }

  /* 蒙层 */
  .sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .sidebar-overlay.visible {
    opacity: 1;
    visibility: visible;
  }

  @media (min-width: 769px) {
    .sidebar-overlay {
      display: none;
    }
  }

  .sidebar-header {
    padding: 20px;
    position: relative;
  }

  .sidebar-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 18px;
    color: var(--primary-color);
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sidebar-close:hover {
    color: var(--primary-color);
    opacity: 0.8;
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 0 0 20px 0;
    width: 100%;
  }

  /* 设置面板 */
  .settings {
    width: 100%;
    margin-top: 40px;
  }

  .settings-list {
    display: flex;
    flex-wrap: wrap;
    border-top: 1px solid #eee;
    box-sizing: content-box;
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  :global(html.dark) .settings-list {
    border-top-color: #4a4a4a;
  }

  .settings-item {
    cursor: pointer;
    font-size: 14px;
    width: 50%;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2px;
    border-bottom: 1px solid #eee;
    color: #000000;
    transition: background-color 0.3s ease;
    margin-bottom: 0;
    list-style: none;
  }

  :global(html.dark) .settings-item {
    border-bottom-color: #4a4a4a;
    color: #ffffff;
  }

  .settings-item:nth-child(odd) {
    border-right: 1px solid #eee;
  }

  :global(html.dark) .settings-item:nth-child(odd) {
    border-right-color: #4a4a4a;
  }

  .settings-item:hover {
    background-color: #eee;
    color: var(--primary-color);
  }

  :global(html.dark) .settings-item:hover {
    background-color: #3c3c3c;
    color: var(--primary-color);
  }

  .settings-item svg {
    width: 16px;
    height: 16px;
  }

  .sidebar-title {
    margin-top: 15px;
    margin-bottom: 5px;
    color: rgba(0, 0, 0, 0.65);
    font-size: 16px;
    font-weight: bold;
    margin-left: 12px;
  }

  :global(html.dark) .sidebar-title {
    color: #ffffff;
  }

  /* 主内容区 */
  .post-main {
    max-width: 960px;
    margin: 0 auto;
    padding: 0 20px;
    transition: transform 0.3s ease;
    will-change: transform;
  }

  .post-main.shifted {
    transform: translateX(100px);
  }

  @media (max-width: 768px) {
    .post-main {
      padding: 0 16px;
    }

    .post-main.shifted {
      transform: none;
    }
  }

  .home-link-wrapper {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
    margin-top: 20px;
  }

  .home-link {
    display: inline-flex;
    align-items: center;
    font-size: 1.2rem;
    color: var(--primary-color);
    text-decoration: none;
  }

  .home-link:hover,
  .home-link:focus,
  .home-link:active {
    text-decoration: none;
    opacity: 0.8;
  }

  .home-link svg {
    font-size: 16px;
    margin-right: 5px;
  }

  .post-header {
    text-align: center;
    margin-bottom: 24px;
  }

  .title-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    border-bottom: 1px solid var(--line-color);
    margin-bottom: 12px;
    position: relative;
  }

  .post-title {
    color: var(--primary-color);
    font-size: 1.75rem;
    margin: 0;
    margin-bottom: 16px;
  }

  .title-row .download-link {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-70%);
    color: var(--primary-color);
    padding: 6px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
  }

  .title-row .download-link:hover {
    opacity: 0.7;
  }

  .title-row .download-link::after {
    content: attr(data-tooltip);
    position: absolute;
    right: 0;
    top: 100%;
    margin-top: 4px;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 13px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.15s, visibility 0.15s;
    pointer-events: none;
  }

  .title-row .download-link:hover::after {
    opacity: 1;
    visibility: visible;
  }

  @media (max-width: 768px) {
    .post-title {
      font-size: 1.35rem;
    }

    .title-row .download-link {
      display: none;
    }
  }

  .post-date {
    color: var(--secondary-color);
    font-size: 1rem;
    margin-bottom: 24px;
  }

  .post-content {
    line-height: 1.8;
  }

  .post-content :global(h1),
  .post-content :global(h2),
  .post-content :global(h3),
  .post-content :global(h4),
  .post-content :global(h5),
  .post-content :global(h6) {
    margin-top: 24px;
    margin-bottom: 16px;
  }

  .footer {
    text-align: center;
    margin-top: 40px;
    padding: 20px 0 10px;
    border-top: 1px solid var(--line-color);
    color: var(--secondary-color);
    font-size: 14px;
  }

  :global(html.dark) .footer {
    border-top-color: #4a4a4a;
  }
</style>
